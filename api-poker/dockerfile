FROM node:20-alpine

# Crée le répertoire de travail
WORKDIR /app

# Copie les fichiers de dépendances
COPY package*.json ./

# Installe les dépendances
RUN npm ci

# Copie le reste du code
COPY . .

# IMPORTANT : Change le propriétaire de tout le workspace
RUN chown -R node:node /app

# Bascule sur l'utilisateur non-privilégié
USER nodecat /proc/self/status | grep NoNewPrivs

# Build l'application (sera fait en tant que 'node', pas 'root')
RUN npm run build

# Expose le port
EXPOSE 3000

# Lance l'application
CMD ["npm", "run", "start:dev"]
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poker Texas Hold'em</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #ffd700;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* Login Screen */
    .login-form {
      max-width: 400px;
      margin: 50px auto;
      background: #16213e;
      padding: 30px;
      border-radius: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
    }

    input {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: #0f3460;
      color: #fff;
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 5px;
      background: #e94560;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background: #c23550;
    }

    button.secondary {
      background: #0f3460;
    }

    button.secondary:hover {
      background: #1a5490;
    }

    .info {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: #0f3460;
      border-radius: 5px;
    }

    .error {
      color: #e94560;
      text-align: center;
      margin-top: 10px;
    }

    /* Lobby Screen */
    .lobby-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: #16213e;
      border-radius: 10px;
    }

    .user-info {
      color: #ffd700;
      font-size: 18px;
    }

    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .table-card {
      background: #16213e;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #0f3460;
    }

    .table-card h3 {
      color: #ffd700;
      margin-bottom: 15px;
    }

    .table-info {
      margin-bottom: 10px;
      color: #aaa;
    }

    .table-card button {
      width: 100%;
      margin-top: 10px;
    }

    /* Game Screen */
    .game-container {
      background: #16213e;
      padding: 30px;
      border-radius: 10px;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #0f3460;
    }

    .pot {
      font-size: 24px;
      color: #ffd700;
      font-weight: bold;
    }

    .players-area {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .player-box {
      background: #0f3460;
      padding: 20px;
      border-radius: 10px;
      border: 3px solid transparent;
    }

    .player-box.active {
      border-color: #ffd700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    .player-box.ai {
      opacity: 0.8;
    }

    .player-name {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #ffd700;
    }

    .player-chips {
      font-size: 16px;
      color: #4ecca3;
      margin-bottom: 10px;
    }

    .player-cards {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .card {
      background: #fff;
      color: #000;
      padding: 20px 15px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      min-width: 60px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .card.hidden {
      background: #e94560;
      color: transparent;
    }

    .card.red {
      color: #e94560;
    }

    .actions-area {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .actions-area button {
      flex: 1;
      padding: 15px;
      font-size: 18px;
    }

    .game-log {
      margin-top: 30px;
      background: #0f3460;
      padding: 20px;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .game-log h3 {
      margin-bottom: 15px;
      color: #ffd700;
    }

    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid #16213e;
      color: #aaa;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .raise-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .raise-input input {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
      <h1>üÉè Poker Texas Hold'em üÉè</h1>
      <div class="login-form">
        <h2 style="text-align: center; margin-bottom: 20px;">Connexion</h2>
        
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="loginUsername" placeholder="Votre pseudo">
        </div>
        
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="votre@email.com">
        </div>
        
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>

        <button onclick="register()">S'inscrire (1000‚Ç¨)</button>
        <button class="secondary" onclick="login()">Se connecter</button>
        
        <div id="loginError" class="error"></div>
      </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="screen">
      <h1>üÉè Lobby - Tables de Poker üÉè</h1>
      
      <div class="lobby-header">
        <div class="user-info">
          <div>üë§ <span id="userUsername">Player</span></div>
          <div>üí∞ <span id="userBankroll">1000</span>‚Ç¨</div>
          <div class="stat-card">
            <p>Parties jou√©es : <span id="statGames">0</span></p>
            <p>Victoires : <span id="statWon">0</span></p>
            <p>Taux de victoire : <span id="statWinRate">0%</span></p>
          </div>
        </div>
        <div>
          <button onclick="showCreateTableForm()">+ Cr√©er une table</button>
          <button class="secondary" onclick="refreshTables()">üîÑ Rafra√Æchir</button>
          <button class="secondary" onclick="logout()">D√©connexion</button>
        </div>
      </div>

      <div id="createTableForm" style="display: none; max-width: 400px; margin: 0 auto 30px; background: #16213e; padding: 20px; border-radius: 10px;">
        <h3 style="margin-bottom: 15px;">Cr√©er une nouvelle table</h3>
        <div class="form-group">
          <label>Nom de la table</label>
          <input type="text" id="tableName" placeholder="Table VIP">
        </div>
        <div class="form-group">
          <label>Petite blind</label>
          <input type="number" id="smallBlind" value="10">
        </div>
        <div class="form-group">
          <label>Grosse blind</label>
          <input type="number" id="bigBlind" value="20">
        </div>
        <button onclick="createTable()">Cr√©er</button>
        <button class="secondary" onclick="hideCreateTableForm()">Annuler</button>
      </div>

      <div id="tablesContainer" class="tables-grid">
        <!-- Tables will be loaded here -->
      </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
      <div class="game-container">
        <div class="game-header">
          <h1>üÉè Partie en cours</h1>
          <div class="pot">Pot: <span id="gamePot">0</span>‚Ç¨</div>
          <button class="secondary" onclick="leaveGame()">Quitter la partie</button>
        </div>

        <div class="players-area">
          <!-- Player 1 (You) -->
          <div id="player1Box" class="player-box">
            <div class="player-name">üë§ <span id="player1Name">Vous</span></div>
            <div class="player-chips">üí∞ <span id="player1Chips">1000</span>‚Ç¨</div>
            <div style="color: #aaa;">Mise: <span id="player1Bet">0</span>‚Ç¨</div>
            <div class="player-cards" id="player1Cards">
              <!-- Cards will appear here -->
            </div>
          </div>

          <!-- Player 2 (AI) -->
          <div id="player2Box" class="player-box ai">
            <div class="player-name">ü§ñ <span id="player2Name">IA</span></div>
            <div class="player-chips">üí∞ <span id="player2Chips">1000</span>‚Ç¨</div>
            <div style="color: #aaa;">Mise: <span id="player2Bet">0</span>‚Ç¨</div>
            <div class="player-cards" id="player2Cards">
              <!-- Hidden cards -->
            </div>
          </div>
        </div>

        <div class="actions-area">
          <button onclick="fold()">Fold (Se coucher)</button>
          <button onclick="call()">Call (Suivre)</button>
          <button onclick="showRaiseInput()">Raise (Relancer)</button>
        </div>

        <div id="raiseInputArea" style="display: none; margin-top: 20px;">
          <div style="background: #0f3460; padding: 20px; border-radius: 10px;">
            <label style="display: block; margin-bottom: 10px; color: #ffd700; font-size: 16px;">üí∞ Montant de la relance (‚Ç¨)</label>
            <div style="display: flex; gap: 10px;">
              <input type="number" id="raiseAmount" placeholder="Ex: 50" min="1" style="flex: 1;">
              <button onclick="raise()" style="width: auto; padding: 10px 30px;">‚úÖ Relancer</button>
              <button class="secondary" onclick="hideRaiseInput()" style="width: auto; padding: 10px 30px;">‚ùå Annuler</button>
            </div>
          </div>
        </div>

        <div class="game-log">
          <h3>üìú Historique</h3>
          <div id="gameLog">
            <div class="log-entry">En attente du d√©but de la partie...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3030';
    let token = localStorage.getItem('poker_token');
    let currentUserId = localStorage.getItem('userId');
    let currentTableId = null;
  let currentGameState = null;
    const GAMBLER_NAMES = [
  "Tsunade (La L√©gendaire Perdante)",
  "Kaiji It≈ç",
  "Yumeko Jabami",
  "Lando Calrissian",
  "Joey Wheeler",
  "Double-Face",
  "James Bond",
  "Jabba le Hutt",
  "Homer Simpson",
  "Bender"
];


  if (token && currentUserId) {
      refreshDashboardStats();
  }
  let BOT_NAME = "En attente..."; // Variable globale
      if (token) {
        // loadUserProfile();
      }

    // ===== AUTH FUNCTIONS =====
    async function refreshDashboardStats() {
    const idToUse = currentUserId || localStorage.getItem('userId');
    const tokenToUse = token || localStorage.getItem('poker_token');

    if (!idToUse || !tokenToUse) return;

    try {
        const response = await fetch(`${API_URL}/players/${idToUse}/stats`, { // URL corrig√©e : /id/stats
            headers: { 'Authorization': `Bearer ${tokenToUse}` }
        });

        if (response.ok) {
            // L'ERREUR √âTAIT ICI : il faut bien attendre la r√©ponse avant de l'utiliser
            const stats = await response.json(); 
            
            console.log("Stats re√ßues :", stats);

            // Maintenant on peut utiliser 'stats'
            document.getElementById('userUsername').textContent = stats.username;
            document.getElementById('userBankroll').textContent = stats.totalChips;
            document.getElementById('statGames').textContent = stats.gamesPlayed;
            document.getElementById('statWon').textContent = stats.gamesWon;
            document.getElementById('statWinRate').textContent = stats.winRate;
        } else {
            console.error("Erreur API :", response.status);
        }
    } catch (error) {
        // C'est ici que ton erreur s'affichait
        console.error("Erreur refresh stats:", error);
    }
}

    window.onload = async () => {
    const storedToken = localStorage.getItem('poker_token');
    const storedId = localStorage.getItem('userId');

    if (storedToken && storedId) {
        token = storedToken;
        currentUserId = storedId;
        
        showScreen('lobbyScreen'); // On montre le dashboard
        await refreshDashboardStats();
        refreshTables();
    } else {

        logout();
        showScreen('loginScreen');
    }
};

    async function register() {
      const username = document.getElementById('loginUsername').value;
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!username || !email || !password) {
        showError('Tous les champs sont obligatoires');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        const data = await response.json();

        if (response.ok) {
          token = data.token;
          localStorage.setItem('token', token);
          currentUser = data.user;
          showScreen('lobbyScreen');
          updateUserInfo();
          refreshTables();
        } else {
          showError(data.message || 'Erreur lors de l\'inscription');
        }
      } catch (error) {
        showError('Erreur de connexion au serveur');
      }
    }

    async function login() {
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;

  if (!username || !password) {
    showError('Username et password obligatoires');
    return;
  }

  try {
    const response = await fetch(`${API_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    const data = await response.json();

    if (response.ok) {
      // 1. On met √† jour les variables globales AVANT d'appeler les stats
      token = data.token; 
      currentUserId = data.userId;

      // 2. Stockage
      localStorage.setItem('poker_token', token);
      localStorage.setItem('userId', currentUserId);

      // 3. Interface
      showScreen('lobbyScreen');
      
      // 4. On lance les refreshs
      await refreshDashboardStats(); 
      refreshTables();
    } else {
      showError(data.message || 'Identifiants invalides');
    }
  } catch (error) {
    showError('Erreur de connexion au serveur');
  }
}

    // async function loadUserProfile() {
    //   try {
    //     const response = await fetch(`${API_URL}/auth/me`, {
    //       headers: { 'Authorization': `Bearer ${token}` }
    //     });

    //     if (response.ok) {
    //       currentUser = await response.json();
    //       showScreen('lobbyScreen');
    //       updateUserInfo();
    //       refreshTables();
    //     } else {
    //       logout();
    //     }
    //   } catch (error) {
    //     logout();
    //   }
    // }

    function logout() {
    // On vide tout
    localStorage.removeItem('poker_token');
    localStorage.removeItem('userId');
    token = null;
    currentUserId = null;

    showScreen('loginScreen');

    // window.location.reload(); 
}
    // function updateUserInfo() {
    //   if (currentUser) {
    //     document.getElementById('userUsername').textContent = currentUser.username;
    //     document.getElementById('userBankroll').textContent = currentUser.chips || currentUser.bankroll || 1000;
    //   }
    // }

    // ===== LOBBY FUNCTIONS =====
    function showCreateTableForm() {
      document.getElementById('createTableForm').style.display = 'block';
    }

    function hideCreateTableForm() {
      document.getElementById('createTableForm').style.display = 'none';
    }

    async function createTable() {
      const name = document.getElementById('tableName').value || 'Table';
      const smallBlind = parseInt(document.getElementById('smallBlind').value) || 10;
      const bigBlind = parseInt(document.getElementById('bigBlind').value) || 20;

      try {
        const response = await fetch(`${API_URL}/tables`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            name,
            maxPlayers: 6,
            smallBlind,
            bigBlind
          })
        });

        if (response.ok) {
          hideCreateTableForm();
          refreshTables();
        } else {
          alert('Erreur lors de la cr√©ation de la table');
        }
      } catch (error) {
        alert('Erreur de connexion au serveur');
      }
    }

    async function refreshTables() {
      try {
        const response = await fetch(`${API_URL}/tables`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const tables = await response.json();
          displayTables(tables);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des tables:', error);
      }
    }

    function displayTables(tables) {
    const container = document.getElementById('tablesContainer');

    const availableTables = tables.filter(table => table.status === 'waiting');

    if (availableTables.length === 0) {
      container.innerHTML = '<div style="text-align: center; color: #aaa; padding: 50px;">Aucune table disponible. Cr√©ez-en une !</div>';
      return;
    }

    container.innerHTML = availableTables.map(table => `
      <div class="table-card">
        <h3>${table.name}</h3>
        <div class="table-info">üë• Joueurs: ${table.players?.length || 0}/${table.maxPlayers}</div>
        <div class="table-info">üí∞ Blinds: ${table.smallBlind}‚Ç¨ / ${table.bigBlind}‚Ç¨</div>
        <div class="table-info">üìä Status: En attente</div>
        <button onclick="joinTable('${table.id}')">
            üéÆ Rejoindre
          </button>
        </div>
      `).join('');
    }

      async function joinTable(tableId) {
        try {
          const response = await fetch(`${API_URL}/tables/${tableId}/join`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (response.ok) {
            currentTableId = tableId;
            await startGame(tableId);
          } else {
            const error = await response.json();
            alert(error.message || 'Impossible de rejoindre la table');
          }
        } catch (error) {
          alert('Erreur de connexion au serveur');
        }
      }

      // ===== GAME FUNCTIONS =====

      
      async function startGame(tableId) {

        BOT_NAME = GAMBLER_NAMES[Math.floor(Math.random() * GAMBLER_NAMES.length)];

        try {
          const response = await fetch(`${API_URL}/game/tables/${tableId}/start`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (response.ok) {
            let responseData = await response.json();
            
            // L'API renvoie { message: "...", table: {...} }
            let gameState = responseData.table || responseData;
            
            // L'API peut aussi renvoyer un array
            if (Array.isArray(gameState)) {
              gameState = gameState[0];
            }
            
            currentGameState = gameState;
            showScreen('gameScreen');
            updateGameUI(gameState);
            addLog('üéÆ Partie d√©marr√©e ! Les cartes sont distribu√©es.');
          } else {
            const error = await response.json();
            alert(error.message || 'Impossible de d√©marrer la partie');
          }
        } catch (error) {
          alert('Erreur lors du d√©marrage de la partie');
          console.error(error);
        }
      }

      function updateGameUI(gameState) {
      // Mise √† jour du Pot
      const potElement = document.getElementById('gamePot');
      if (potElement) potElement.textContent = gameState.pot || 0;

      if (gameState.players && gameState.players.length >= 2) {
          const player1 = gameState.players[0];
          const player2 = gameState.players[1];

          // Mise √† jour Player 1 (Vous)
          const p1Name = document.getElementById('player1Name');
          if (p1Name) p1Name.textContent = player1.username;
          
          const p1Chips = document.getElementById('player1Chips');
          if (p1Chips) p1Chips.textContent = player1.chips;

          // Mise √† jour Player 2 (IA)
          const player2Box = document.getElementById('player2Box');
          if (player2Box) {
          const isBotTurn = (gameState.currentPlayerIndex === 1 && gameState.status === 'playing');
          const p2Name = document.getElementById('player2Name');

          
          if (p2Name) {
              p2Name.textContent = BOT_NAME
          }
          
          // Highlight si c'est son tour
          player2Box.classList.toggle('active', isBotTurn);
          
          const p2Chips = document.getElementById('player2Chips');
          if (p2Chips) p2Chips.textContent = player2.chips;
          }

          // Gestion des cartes
          renderCards('player1Cards', player1.cards);
          
          // R√©v√©lation des cartes du bot
          if (gameState.status === 'finished') {
          renderCards('player2Cards', player2.cards);
          } else {
          const p2Cards = document.getElementById('player2Cards');
          if (p2Cards) p2Cards.innerHTML = '<div class="card hidden">üÇ†</div><div class="card hidden">üÇ†</div>';
          }
      }
      }
      
      function renderCards(elementId, cards) {
          const div = document.getElementById(elementId);
              if (cards && cards.length > 0) {
                  div.innerHTML = cards.map(card => 
                  `<div class="card ${isRedSuit(card) ? 'red' : ''}">${card}</div>`
              ).join('');
          }
      }


      function formatCard(cardString) {
        // Les cartes sont d√©j√† format√©es par l'API (ex: "J‚ô£", "5‚ô¶")
        return cardString || '?';
      }

      function isRedSuit(cardString) {
        // Les cartes rouges contiennent ‚ô• ou ‚ô¶
        return cardString && (cardString.includes('‚ô•') || cardString.includes('‚ô¶'));
      }

      async function fold() {
        await playAction('fold');
      }

      async function call() {
        await playAction('call');
      }

      function showRaiseInput() {
        document.getElementById('raiseInputArea').style.display = 'flex';
      }

      function hideRaiseInput() {
        document.getElementById('raiseInputArea').style.display = 'none';
      }

      async function raise() {
        const amount = parseInt(document.getElementById('raiseAmount').value);
        if (!amount || amount <= 0) {
          alert('Montant invalide');
          return;
        }
        hideRaiseInput();
        await playAction('raise', amount);
      }

      async function playAction(action, amount = null) {
    try {
      // 1. D√©sactiver les boutons pour √©viter le spam pendant les 2s de r√©flexion
      disableActionButtons(true);
      
      // 2. Affichage imm√©diat dans l'historique
      addLog(`‚è≥ Vous avez choisi : ${action}${amount ? ' (' + amount + '‚Ç¨)' : ''}`);
      
      // Message d'ambiance pour montrer que le Bot prend la main
      const botThinkingMsg = `üí¨ ${BOT_NAME} examine ses cartes...`;
      addLog(botThinkingMsg);

      // Pr√©paration du corps de la requ√™te
      const body = { action };
      if (amount !== null) body.amount = amount;

      // 3. Appel API (Le 'await' va bloquer ici pendant les 2 secondes du serveur)
      const response = await fetch(`${API_URL}/game/tables/${currentTableId}/action`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });

      if (response.ok) {
        const data = await response.json();
        // On r√©cup√®re l'objet table (soit directement, soit dans data.table)
        let gameState = data.table || data;
        if (Array.isArray(gameState)) gameState = gameState[0];

        currentGameState = gameState;
        
        // 4. Mise √† jour visuelle (Jetons, Cartes, etc.)
        updateGameUI(gameState);

        // 5. Analyse du r√©sultat renvoy√© par le serveur
        if (gameState.status === 'finished') {
          // Le bot s'est forc√©ment couch√© selon ta logique service
          addLog(`‚ùå ${BOT_NAME} ne veut pas prendre de risque et se couche (Fold).`);
          
          const winnerName = gameState.lastWinner || "L'adversaire";
          addLog(`üèÜ FIN DE PARTIE : ${winnerName} remporte le pot !`);
          
          refreshDashboardStats();
          // Laisser les cartes visibles 5 secondes avant de fermer l'alerte
          setTimeout(() => {
            alert(`Partie termin√©e ! Gagnant : ${winnerName}`);
            // Optionnel : Retour au lobby ou reset
            showScreen('lobbyScreen');
            refreshTables();
          }, 5000);
        } else {
          // Si la partie n'est pas finie, on v√©rifie si c'est √† nouveau notre tour
          const isMyTurn = (gameState.currentPlayerIndex === 0);
          disableActionButtons(!isMyTurn);
        }

      } else {
        const error = await response.json();
        addLog(`‚ùå Erreur : ${error.message}`);
        disableActionButtons(false);
      }
    } catch (error) {
      console.error("D√©tails playAction:", error);
      addLog('‚ùå Erreur technique de connexion au serveur');
      disableActionButtons(false);
    }
  }

      function disableActionButtons(disabled) {
        const buttons = document.querySelectorAll('.actions-area button');
        buttons.forEach(button => {
          button.disabled = disabled;
          button.style.opacity = disabled ? '0.5' : '1';
          button.style.cursor = disabled ? 'not-allowed' : 'pointer';
        });
      }

      function leaveGame() {
        currentTableId = null;
        currentGameState = null;
        showScreen('lobbyScreen');
        refreshTables();
      }

      function addLog(message) {
        const logDiv = document.getElementById('gameLog');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
        logDiv.insertBefore(entry, logDiv.firstChild);
      }

      // ===== UTILITY FUNCTIONS =====
      function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
          screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
      }

      function showError(message) {
        document.getElementById('loginError').textContent = message;
        setTimeout(() => {
          document.getElementById('loginError').textContent = '';
        }, 5000);
      }
    </script>
  </body>
  </html>